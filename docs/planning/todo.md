# Features

Backlog of small tasks for nephewbot to pick off. Each item should be self-contained and implementable without external coordination. Items are ordered by priority — nephewbot picks the top unchecked item.

## quick wins

- [ ] Add Cmd+K / Ctrl+K shortcut to focus the page's search input. Create a client component `webapp/src/components/search-focus-handler.tsx` that registers a global `keydown` listener for `Meta+k` (Mac) and `Control+k` (other platforms). On trigger, `preventDefault()` and focus the first `input[type="search"]` or `input[name="q"]` on the page. The nav bar search input (`webapp/src/components/nav.tsx`) is always present, so this acts as the default target. On pages with their own search input (like `/search`, admin user list), the page-level input will be found first if it appears earlier in the DOM. To make the nav search focusable from a client component, add an `id="nav-search"` attribute to the nav input. The handler should bail out (not prevent default) if the user is already focused on any input, textarea, or contenteditable element. Mount the component in `webapp/src/app/layout.tsx`. Show a subtle `⌘K` hint badge inside the nav search input (right-aligned, muted text) as a discoverability affordance.

- [ ] Add sort options to shelf detail page. On `GET /users/:username/shelves/:slug` in `api/handlers/users.go`, accept a `sort` query param with values `title`, `author`, `date_added` (default), `rating`. Apply `ORDER BY` accordingly in the SQL query. In the webapp at `webapp/src/app/[username]/library/[slug]/page.tsx`, add a sort dropdown (same pattern as the existing sort dropdown on `/users` page from PR #80). Forward the `sort` param through the Next.js proxy route. Default to `date_added` descending.

- [ ] Add confirmation dialog when removing a book from library. In `webapp/src/components/shelf-picker.tsx` (or wherever the "Remove from library" action lives), wrap the `DELETE /api/me/books/:olId` call with a confirmation modal: "Remove *{title}* from your library? Your rating, review, and reading progress will be deleted." Use a simple dialog component — no external dependency needed. The confirm button should be red/destructive styled. Cancel closes the dialog with no action.

- [ ] Add toast notifications for user actions. Create a minimal toast system in `webapp/src/components/toast.tsx` — a React context provider with `useToast()` hook exposing `toast.success(message)` and `toast.error(message)`. Render toasts as fixed-position banners in the bottom-right, auto-dismiss after 4 seconds. Wire it into existing actions: book added to library, status changed, review saved, follow/unfollow, import complete. No external dependency — just a context + CSS transitions.

- [ ] Add book cover fallback placeholder. When a book has no `cover_url`, the UI currently shows a broken image or blank space. Create a `BookCoverPlaceholder` component in `webapp/src/components/book-cover-placeholder.tsx` that renders a styled div with the book title text and author in a muted color on a neutral background. Use it as the fallback everywhere book covers are rendered: search results, shelf grids, profile sections, book detail page. Check all places that render `<img>` with a book cover URL and add an `onError` fallback or conditional render.

- [ ] Add "date started" tracking for books. Add a `date_started` column (timestamptz, nullable) to `user_books` via a new migration in `api/migrations/`. Update `PATCH /me/books/:olId` in `api/handlers/userbooks.go` to accept `date_started` in the request body and persist it. When a book's status is changed to "Currently Reading" via `setStatusLabel` and `date_started` is null, auto-set it to `now()`. Return `date_started` in the book detail and user book responses. On the book detail page (`webapp/src/app/books/[workId]/page.tsx`), show "Started: {date}" when set. Include in CSV export.

## stats & data

- [ ] Add reading pace calculation for currently-reading books. In the reading progress component (`webapp/src/components/reading-progress.tsx`), when a book has `progress_pages > 0` and `date_started` (or `date_added` as fallback), calculate pages per day = `progress_pages / days_elapsed`. Show estimated finish date = `today + (total_pages - progress_pages) / pages_per_day`. Display below the progress bar as "~X pages/day · Est. finish: {date}". Only show when there's enough data (at least 1 day of reading and a known total page count). This is purely frontend — no API changes needed.

- [ ] Add re-read tracking. Create a `reading_sessions` table via migration: `id` (uuid PK), `user_id` (FK → users), `book_id` (FK → books), `date_started` (timestamptz nullable), `date_finished` (timestamptz nullable), `rating` (smallint nullable 1-5), `notes` (text nullable), `created_at`. Unique constraint: none (multiple sessions per book allowed). API endpoints in a new `api/handlers/sessions.go`: `GET /me/books/:olId/sessions` (list sessions), `POST /me/books/:olId/sessions` (create), `PATCH /me/sessions/:sessionId` (update), `DELETE /me/sessions/:sessionId`. The existing `user_books` record keeps the "current" status/rating/review; sessions are historical. On the book detail page, add a "Reading History" section below the user's review showing past reads with dates and ratings. Webapp proxy routes: `GET/POST /api/me/books/:olId/sessions`, `PATCH/DELETE /api/me/sessions/:sessionId`.

- [ ] Add "year in review" summary page. Create a `GET /users/:username/year-in-review?year=2025` endpoint in `api/handlers/users.go` that returns: total books finished, total pages read (sum of `books.page_count` for finished books), average rating, highest-rated book, most common genres (from `genre_ratings` or `books.subjects`), books per month breakdown, longest book, shortest book. All data derived from existing `user_books` + `books` tables filtered by `date_read` year. Respects profile privacy. Create the page at `webapp/src/app/[username]/year-in-review/page.tsx` with cards for each stat and a month-by-month grid of book covers. Link from the stats page and profile.

- [ ] Backfill book_stats on a schedule. Currently `book_stats` is only refreshed when individual users change a book's status/rating. Add a background goroutine in `api/main.go` (similar to `notifications.StartPoller`) that runs `bookstats.BackfillAll` once every 24 hours to catch any drift from edge cases (deleted users, failed goroutines, import edge cases). Log the backfill duration and number of rows updated. The existing startup backfill already runs on boot — this just adds a periodic re-check.

## notifications & feed

- [ ] Add feed filtering by activity type. On the feed page (`webapp/src/app/feed/page.tsx`), add a row of filter chips above the feed: "All", "Reviews", "Status Updates", "Threads", "Social". Clicking a chip passes `?type=reviewed` (or `shelved`, `created_thread`, `followed_user`, etc.) to the API. In `api/handlers/activity.go` `GetFeed`, accept a `type` query param and add a `WHERE activity_type = ?` clause when present. Multiple types could be comma-separated (e.g. `?type=rated,reviewed`). Default (no param) returns all types as before.

- [ ] Add digest email notifications. Add a `digest_frequency` column to `notification_preferences` via migration: `varchar(20)`, default `'none'`, values `'none'`, `'daily'`, `'weekly'`. Add a UI toggle on the notification preferences settings page (PR #59 adds the preferences page — this extends it). Add a background job in `api/main.go` that runs hourly: for users with `digest_frequency = 'daily'`, send at 9am in their timezone (or UTC if no timezone); for `'weekly'`, send Monday 9am. The email lists unread notifications since last digest. Uses the existing `email.Send` pattern from password reset. Skip if SMTP is not configured.

## profile & social

- [ ] Add "friends reading this" on book detail page. On the book detail page (`webapp/src/app/books/[workId]/page.tsx`), below the book stats, show a row of avatar thumbnails for users the viewer follows who have this book in their library (any status). API: add a `GET /books/:workId/readers?followers_of=:userId` endpoint in `api/handlers/books.go` that queries `user_books` JOIN `follows` WHERE `followee_id` IN (users who have the book) AND `follower_id = :userId`. Return up to 5 users with avatar, username, and their status for this book. Only return non-private users (or users the viewer follows). Frontend: render as small avatar circles with tooltip showing username and status. Link each to their profile.

- [ ] Add follow suggestions on feed page. When the feed is empty or at the bottom of the feed, show a "People you might like" section. API: add `GET /me/suggested-follows?limit=5` endpoint in `api/handlers/users.go`. Logic: find users who have the most books in common with the current user (JOIN `user_books` on matching `book_id`, exclude already-followed and blocked users), ordered by overlap count descending. Return user profile data (username, display_name, avatar, books_in_common count). Frontend: render as user cards with follow buttons and "X books in common" label. Show on the feed page in a sidebar or below the feed.

- [ ] Add profile banner image. Add a `banner_url` column (text, nullable) to `users` via migration. Add `POST /me/banner` endpoint in `api/handlers/userdata.go` (same pattern as `POST /me/avatar` — multipart upload, resize to 1200x300 max, store in PocketBase file storage). Return the banner URL in `GET /users/:username` profile response. On the profile page (`webapp/src/app/[username]/page.tsx`), render the banner as a full-width image behind the avatar/name area. On the settings page, add a banner upload field below the avatar upload in the existing `SettingsForm`.

- [ ] Add "favorite genres" display on profile. On the user profile page, below the bio section, show a row of genre chips representing the user's most-read genres. Derive from the user's finished books' `subjects` field: parse the comma-separated subjects, count occurrences, display the top 5 as colored chips (reuse the genre color scheme from the genres page). This is computed at render time from existing data — no new API endpoint needed, just include genre distribution in the existing `GET /users/:username` response or compute it client-side from the user's books data.

## search & browse

- [ ] Add trending books section to search landing page. Create a `GET /books/trending?period=week&limit=10` endpoint in `api/handlers/books.go`. Query `user_books` for books with the most new `user_books` rows created in the past 7 (or 30) days, grouped by `book_id`, ordered by count descending. Return book data with the activity count. On the search page (`webapp/src/app/search/page.tsx`), when no query is entered (the empty/landing state from PR #79), show a "Trending This Week" section alongside or instead of "Popular Books". Render as a horizontal scrollable book cover row.

- [ ] Add recently viewed books (client-side). In the webapp, create a `useRecentlyViewed` hook in `webapp/src/lib/recently-viewed.ts` that stores the last 10 viewed book IDs + titles + covers in `localStorage`. Update the book detail page (`webapp/src/app/books/[workId]/page.tsx`) to call `addToRecentlyViewed(book)` on mount. On the search page, when no query is entered, show a "Recently Viewed" row above trending/popular books if the list is non-empty. Render as a book cover row with titles. No API changes needed — purely client-side state.

- [ ] Add saved searches. Create a `saved_searches` table via migration: `id` (uuid PK), `user_id` (FK → users, cascade), `name` (varchar(100)), `query` (text), `filters` (jsonb — stores genre, language, year_min, year_max, sort, tab), `created_at`. API endpoints in a new `api/handlers/searches.go`: `GET /me/saved-searches` (list), `POST /me/saved-searches` (create, max 20 per user), `DELETE /me/saved-searches/:id`. On the search page, when filters are active, show a "Save this search" button that opens a name input. Show saved searches as chips above the search bar. Clicking a chip populates the query and filters. Webapp proxy routes: `GET/POST/DELETE /api/me/saved-searches`.

## book detail & discovery

- [ ] Add review sorting options on book detail page. In `GET /books/:workId/reviews` in `api/handlers/books.go`, accept a `sort` query param: `newest` (default — current behavior), `oldest`, `highest` (rating DESC), `lowest` (rating ASC), `most_liked` (LEFT JOIN `review_likes` GROUP BY count DESC — depends on PR #51 being merged, fall back to `newest` if review_likes table doesn't exist). On the book detail page, add a sort dropdown above the reviews section. Forward the `sort` param through the webapp proxy route.

- [ ] Add "more by this author" section on book detail page. On the book detail page (`webapp/src/app/books/[workId]/page.tsx`), below the main book info, show a "More by {Author}" section. Extract the first author's OL author key from the book detail response (the `authors` field may include keys if they were fetched from OL). If an author key is available, call `GET /authors/:authorKey` and display up to 6 book covers in a horizontal row (exclude the current book). If no author key is available, search local books by author name via `GET /books/search?q={authorName}` and filter out the current book. Link "See all" to the author page.

- [ ] Add book quotes/highlights. Create a `book_quotes` table via migration: `id` (uuid PK), `user_id` (FK → users, cascade), `book_id` (FK → books, cascade), `text` (text, max 2000 chars), `page_number` (integer, nullable), `note` (text, nullable, max 500 chars), `is_public` (boolean, default true), `created_at`. API endpoints in `api/handlers/quotes.go`: `GET /books/:workId/quotes` (public quotes for a book, paginated), `GET /me/books/:olId/quotes` (user's own quotes), `POST /me/books/:olId/quotes`, `DELETE /me/quotes/:quoteId`. On the book detail page, add a "Quotes" tab or section showing public quotes with attribution (username, page number). On the user's book view, show an "Add quote" button. Webapp proxy routes for all endpoints.

- [ ] Add thread locking for moderators. Add a `locked_at` column (timestamptz, nullable) to `threads` via migration. Add `POST /threads/:threadId/lock` and `POST /threads/:threadId/unlock` endpoints in `api/handlers/threads.go` — moderator-only (check `is_moderator` from auth). When locked, `POST /threads/:threadId/comments` returns 403 with "This thread is locked." In the frontend, show a lock icon on locked threads and hide the comment form. Moderators see a lock/unlock toggle button on the thread detail page.

- [ ] Add review comments / discussion under reviews. Create a `review_comments` table via migration: `id` (uuid PK), `user_id` (FK → users, cascade), `book_id` (FK → books, cascade), `review_user_id` (FK → users, cascade — the review author), `body` (text, max 2000 chars), `created_at`, `deleted_at` (timestamptz, nullable — soft delete). API endpoints in `api/handlers/reviewcomments.go`: `GET /books/:workId/reviews/:userId/comments` (list comments on a review, paginated), `POST /books/:workId/reviews/:userId/comments` (add comment), `DELETE /review-comments/:commentId` (author or moderator). Generate a `review_comment` notification for the review author. On the book detail page, show a comment count per review and a toggle to expand/collapse the comment thread under each review. Webapp proxy routes for all endpoints.

## settings & account

- [ ] Add shelf descriptions. Add a `description` column (text, nullable, max 1000 chars) to `collections` via migration. Update `POST /me/shelves` and `PATCH /me/shelves/:id` in `api/handlers/collections.go` to accept and persist `description`. Return it in `GET /users/:username/shelves` and shelf detail responses. On the shelf detail page, render the description below the shelf name. On the create/edit shelf form, add a textarea for description. Don't add descriptions to the three default status shelves (Want to Read, Currently Reading, Read).

- [ ] Add LibraryThing CSV import. Add `POST /me/import/librarything/preview` and `POST /me/import/librarything/commit` endpoints in `api/handlers/imports.go`, following the same pattern as Goodreads and StoryGraph imports. LibraryThing CSV format: columns include `Title`, `Author (First, Last)`, `ISBN`, `Rating`, `Review`, `Date Read`, `Collections` (semicolon-separated), `Tags` (comma-separated). Map LT collections to shelves, LT tags to labels. Status mapping: "Currently Reading" → Currently Reading, "To Read" / "Wishlist" → Want to Read, "Read but unowned" / books with a Date Read → Finished. On the import page, add a "LibraryThing" tab alongside Goodreads and StoryGraph (extends PR #61's tabbed UI).

- [ ] Add API token generation for integrations. Create an `api_tokens` table via migration: `id` (uuid PK), `user_id` (FK → users, cascade), `name` (varchar(100) — user-chosen label like "CLI" or "Calibre"), `token_hash` (text — SHA-256 hash), `last_used_at` (timestamptz nullable), `created_at`. API endpoints: `GET /me/api-tokens` (list tokens — return name, created_at, last_used_at, never the raw token), `POST /me/api-tokens` (create — return the raw token once, hash and store), `DELETE /me/api-tokens/:id`. In auth middleware, also check for `Authorization: Bearer <token>` against `api_tokens` (hash the incoming token and look up). Add a "Developer" or "API Tokens" section to settings page with create/revoke UI. Max 5 tokens per user.

## UX polish

- [ ] Add loading skeleton components. Create a `Skeleton` component in `webapp/src/components/skeleton.tsx` — a pulsing gray placeholder block that accepts `width`, `height`, and `variant` ("text", "circular", "rectangular") props. Create composed skeletons: `BookGridSkeleton` (grid of cover-sized rectangles), `ProfileSkeleton` (avatar circle + text lines), `ReviewSkeleton` (star row + text block). Use React Suspense boundaries in the main pages (feed, profile, book detail, search results) with these skeletons as fallbacks. No external dependency — CSS animation with `@keyframes`.

- [ ] Add keyboard shortcuts. Create a `useKeyboardShortcuts` hook in `webapp/src/lib/keyboard-shortcuts.ts` that registers global keydown listeners. Shortcuts: `/` focuses the search input (prevent typing "/" in the box), `Escape` closes any open modal/dropdown, `?` shows a shortcuts help overlay. Only register when no input/textarea is focused (except Escape). Show a small "Press ? for shortcuts" hint at the bottom of the page for logged-in users. The shortcuts overlay is a simple modal listing all available shortcuts.

- [ ] Add dark mode. Add a `theme` preference to the user — either in `localStorage` for unauthenticated users or as a `theme` column on `users` (varchar(10), default `'system'`, values `'light'`, `'dark'`, `'system'`). In `webapp/src/app/layout.tsx`, read the theme preference and apply a `data-theme` attribute to `<html>`. Define CSS custom properties for all colors in `globals.css` under `[data-theme="light"]` and `[data-theme="dark"]` selectors. For `system`, use `prefers-color-scheme` media query. Add a theme toggle (sun/moon icon) in the nav bar. Convert existing hardcoded colors to use the CSS custom properties. This is a larger task — start with the infrastructure (toggle, CSS variables, layout attribute) and convert colors page by page.

- [ ] Add empty state illustrations for zero-data pages. For pages that show nothing when a user is new (feed, library, shelves, notifications), add friendly empty state messages with call-to-action links. Feed: "Your feed is empty. Follow some readers to see their activity." with link to `/users`. Library: "No books yet. Search for a book to get started." with link to `/search`. Notifications: "No notifications. You're all caught up!" Shelves: "This shelf is empty. Browse books to add some." Check each page for existing empty handling and add where missing. Use the same visual style (centered text, muted color, optional icon).

## blocked

- [ ] Populate series data from Open Library during book lookup. **BLOCKED: depends on PR #60 (series metadata) being merged first.** Once the `series` and `book_series` collections exist, update `GetBookDetail` in `api/handlers/books.go` to auto-detect series data. The OL editions response (`/works/{workId}/editions.json`) includes a `series` array on some editions. For each edition entry, check for a `series` field. If found, find-or-create a `series` record by name and create a `book_series` link with the position number (if available). Also try the OL work's `subjects` array for series-like patterns (e.g. "Harry Potter" appearing as a subject). This is best-effort — not all OL works have series data. Log when series data is found vs. not for visibility into coverage.

## Pending PRs

<!-- nephewbot moves tasks here when it opens a PR. Move to docs/planning/completed.md after merging. -->
- [Replace raw OL ID input with book search dropdown](https://github.com/ross-corp/rosslib/pull/83) — Search-as-you-type dropdown in Suggest Link form using /api/books/search
- [Show book subjects as tags on book detail page](https://github.com/ross-corp/rosslib/pull/82) — Extract OL subjects and render as pill tags below description
- [Add review likes](https://github.com/ross-corp/rosslib/pull/51) — Toggle like on reviews with heart icon, notifications, and activity recording
- [Add user blocking](https://github.com/ross-corp/rosslib/pull/52) — Block/unblock users with review/search/feed filtering and profile UI
- [Add reading goals](https://github.com/ross-corp/rosslib/pull/53) — Annual reading goal with progress tracking, profile card, and settings form
- [Add @mention notifications in thread comments](https://github.com/ross-corp/rosslib/pull/54) — @username in comments creates thread_mention notifications and renders as profile links
- [Add recommend-to-friend feature](https://github.com/ross-corp/rosslib/pull/55) — Recommend books to users with modal, notifications, and /recommendations page
- [Add detailed reading statistics](https://github.com/ross-corp/rosslib/pull/56) — GET /users/:username/stats with books by year/month, rating distribution, and /[username]/stats page
- [Add reading timeline view](https://github.com/ross-corp/rosslib/pull/57) — GET /users/:username/timeline with year/month grouping and /[username]/timeline page
- [Add content reporting](https://github.com/ross-corp/rosslib/pull/58) — Reports collection with flag icons on reviews/comments/links, modal submission, and admin review panel
- [Add notification preferences](https://github.com/ross-corp/rosslib/pull/59) — Per-user notification toggle switches on settings page with GET/PUT API and ShouldNotify helper
- [Add series metadata](https://github.com/ross-corp/rosslib/pull/60) — Series and book_series collections, API endpoints, book detail series badges, /series/:id page, shelf grid position badges
- [Add StoryGraph CSV import](https://github.com/ross-corp/rosslib/pull/61) — StoryGraph preview/commit endpoints, status mapping, tag import, tabbed import page
- [Fix homepage feature grid responsiveness](https://github.com/ross-corp/rosslib/pull/62) — Add responsive breakpoints (1-col mobile, 2-col sm, 3-col lg) to feature grid
- [Add rating validation to AddBook and UpdateBook](https://github.com/ross-corp/rosslib/pull/64) — Validate rating is in range 1-5 with clear 400 error
- [Add max-length validation to threads and comments](https://github.com/ross-corp/rosslib/pull/65) — Title max 500 chars, body max 10k chars, comment max 5k chars with clear 400 errors
- [Add max-length validation to profile fields](https://github.com/ross-corp/rosslib/pull/66) — display_name max 100 chars, bio max 2000 chars with clear 400 errors
- [Populate friends_count on profile endpoint](https://github.com/ross-corp/rosslib/pull/67) — Count mutual follows (friends) instead of hardcoded 0
- [Populate books_this_year on profile endpoint](https://github.com/ross-corp/rosslib/pull/68) — Count finished books with date_read in current calendar year
- [Populate page_count and publisher from local book records](https://github.com/ross-corp/rosslib/pull/69) — Add migration for page_count/publisher columns and populate from local data in GetBookDetail
- [Return edition_count in GetBookDetail response](https://github.com/ross-corp/rosslib/pull/70) — Fetch edition count from OL editions endpoint and include in book detail JSON
- [Populate book stats for local search results](https://github.com/ross-corp/rosslib/pull/71) — Batch-fetch book_stats for local results to populate average_rating, rating_count, and already_read_count
- [Add distinct icons per notification type](https://github.com/ross-corp/rosslib/pull/72) — Type-specific SVG icons for notification types (book, chat, link, star) with bell fallback
- [Add click-to-mark-read on individual notifications](https://github.com/ross-corp/rosslib/pull/73) — Click unread dot to mark single notification as read with optimistic UI update
- [Show reading progress on other users' profiles](https://github.com/ross-corp/rosslib/pull/74) — Include progress_pages, progress_percent, page_count in GetUserBooks grouped status response
- [Add Want to Read section to profile page](https://github.com/ross-corp/rosslib/pull/75) — Render want-to-read book covers grid on user profiles between Currently Reading and Favorites
- [Add empty states for profile sections on own profile](https://github.com/ross-corp/rosslib/pull/76) — Show helpful empty state messages for Currently Reading, Recent Reviews, and Recent Activity on own profile
- [Add followers/following list pages](https://github.com/ross-corp/rosslib/pull/77) — Followers/following API endpoints with privacy checks, paginated list pages with user cards and follow buttons
- [Add user avatars to People search results](https://github.com/ross-corp/rosslib/pull/78) — Render avatar images with letter fallback on People search tab
- [Add empty/landing state to search page](https://github.com/ross-corp/rosslib/pull/79) — Show prompt message and popular books grid when no query is entered
- [Add sort options to browse-all-users page](https://github.com/ross-corp/rosslib/pull/80) — Sort dropdown (Newest, Most books, Most followers) on /users page
- [Link author names to author pages on book detail](https://github.com/ross-corp/rosslib/pull/81) — Author names link to /authors/{key} pages, with plain text fallback for local-only records
- [Add pagination to author works grid](https://github.com/ross-corp/rosslib/pull/84) — Paginated author works with Show more button (24 per page)
- [Add shared settings page navigation](https://github.com/ross-corp/rosslib/pull/85) — Pill-style SettingsNav component on all settings pages
- [Add followed books management page](https://github.com/ross-corp/rosslib/pull/86) — /settings/followed-books page with book list and unfollow buttons
- [Add pending imports review page](https://github.com/ross-corp/rosslib/pull/87) — /settings/imports/pending page with search & link modal, dismiss, and delete actions
- [Add color-coded genre cards on genres page](https://github.com/ross-corp/rosslib/pull/88) — Distinct muted background colors per genre for visual scannability
