openapi: 3.0.3
info:
  title: Rosslib API
  description: |
    Rosslib is a Goodreads alternative. This API powers the webapp and is available
    for building CLIs, integrations, and third-party tools.

    ## Authentication
    Most read endpoints are public. Write endpoints require a JWT token obtained
    via `/auth/register` or `/auth/login`. Pass the token as:
    ```
    Authorization: Bearer <token>
    ```
    Tokens expire after 30 days.

    ## Conventions
    - Book IDs use bare Open Library work IDs (e.g. `OL82592W`, not `/works/OL82592W`)
    - Dates are RFC 3339 format (e.g. `2025-06-15T00:00:00Z`)
    - Nullable fields return `null` when unset
    - Success responses for mutations return `{"ok": true}`
    - Error responses return `{"error": "description"}`
  version: "1.0.0"
  license:
    name: MIT

servers:
  - url: http://localhost:8080
    description: Local development

tags:
  - name: Auth
    description: Registration and login
  - name: Books
    description: Book search, lookup, and detail
  - name: Authors
    description: Author search and detail
  - name: Genres
    description: Genre browsing
  - name: Genre Ratings
    description: Per-user genre dimension ratings on books (0–10 scale)
  - name: Users
    description: User profiles and social
  - name: Collections
    description: Shelves, tags, and shelf management
  - name: User Books
    description: Per-user book library (status, rating, review, progress)
  - name: Tags
    description: Label keys and values (Status, custom labels)
  - name: Threads
    description: Discussion threads and comments on books
  - name: Activity
    description: Activity feeds
  - name: Import/Export
    description: Goodreads import and CSV export
  - name: Notifications
    description: User notifications (new publications, etc.)
  - name: Admin
    description: Admin-only endpoints (ghost users)

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
      required: [error]

    Ok:
      type: object
      properties:
        ok:
          type: boolean
          example: true

    BookStats:
      type: object
      properties:
        reads_count:
          type: integer
          description: Number of users who have finished this book
        want_to_read_count:
          type: integer
          description: Number of users who want to read this book
        average_rating:
          type: number
          nullable: true
          description: Average user rating (1-5 scale), null if no ratings
        rating_count:
          type: integer
          description: Number of users who have rated this book
        review_count:
          type: integer
          description: Number of users who have written a review
      required: [reads_count, want_to_read_count, rating_count, review_count]

    Notification:
      type: object
      properties:
        id:
          type: string
          format: uuid
        notif_type:
          type: string
          description: "Notification type (e.g. new_publication)"
        title:
          type: string
        body:
          type: string
          nullable: true
        metadata:
          type: object
          additionalProperties:
            type: string
          nullable: true
        read:
          type: boolean
        created_at:
          type: string
          format: date-time

    AuthResponse:
      type: object
      properties:
        token:
          type: string
        user_id:
          type: string
          format: uuid
        username:
          type: string

    BookResult:
      type: object
      properties:
        key:
          type: string
          description: "Open Library work key, e.g. /works/OL82592W"
        title:
          type: string
        authors:
          type: array
          items:
            type: string
        publish_year:
          type: integer
          nullable: true
        isbn:
          type: array
          items:
            type: string
        cover_url:
          type: string
          nullable: true
        edition_count:
          type: integer
        average_rating:
          type: number
          nullable: true
        rating_count:
          type: integer
        already_read_count:
          type: integer
        subjects:
          type: array
          items:
            type: string

    BookDetail:
      type: object
      properties:
        key:
          type: string
        title:
          type: string
        authors:
          type: array
          items:
            type: string
        description:
          type: string
          nullable: true
        cover_url:
          type: string
          nullable: true
        average_rating:
          type: number
          nullable: true
        rating_count:
          type: integer
        local_reads_count:
          type: integer
        local_want_to_read_count:
          type: integer
        publisher:
          type: string
          nullable: true
        page_count:
          type: integer
          nullable: true
        first_publish_year:
          type: integer
          nullable: true
        subjects:
          type: array
          items:
            type: string
        edition_count:
          type: integer
        editions:
          type: array
          items:
            $ref: '#/components/schemas/Edition'

    Edition:
      type: object
      properties:
        key:
          type: string
          description: Open Library edition key (bare ID, e.g. OL58959679M)
        title:
          type: string
        publisher:
          type: string
          nullable: true
        publish_date:
          type: string
        page_count:
          type: integer
          nullable: true
        isbn:
          type: string
          nullable: true
        cover_url:
          type: string
          nullable: true
        format:
          type: string
          description: Physical format (e.g. Hardcover, Paperback, eBook)
        language:
          type: string
          description: 3-letter language code (e.g. eng, spa)

    AuthorResult:
      type: object
      properties:
        key:
          type: string
        name:
          type: string
        birth_date:
          type: string
          nullable: true
        death_date:
          type: string
          nullable: true
        top_work:
          type: string
          nullable: true
        work_count:
          type: integer
        top_subjects:
          type: array
          items:
            type: string
        photo_url:
          type: string
          nullable: true

    AuthorDetail:
      type: object
      properties:
        key:
          type: string
        name:
          type: string
        bio:
          type: string
          nullable: true
        birth_date:
          type: string
          nullable: true
        death_date:
          type: string
          nullable: true
        photo_url:
          type: string
          nullable: true
        links:
          type: array
          items:
            type: object
            properties:
              title:
                type: string
              url:
                type: string
        work_count:
          type: integer
        works:
          type: array
          items:
            type: object
            properties:
              key:
                type: string
              title:
                type: string
              cover_url:
                type: string
                nullable: true

    GenreInfo:
      type: object
      properties:
        slug:
          type: string
        name:
          type: string
        book_count:
          type: integer

    ProfileResponse:
      type: object
      properties:
        user_id:
          type: string
          format: uuid
        username:
          type: string
        display_name:
          type: string
          nullable: true
        bio:
          type: string
          nullable: true
        avatar_url:
          type: string
          nullable: true
        is_private:
          type: boolean
        member_since:
          type: string
          format: date-time
        is_following:
          type: boolean
        follow_status:
          type: string
          enum: [none, pending, active]
        followers_count:
          type: integer
        following_count:
          type: integer
        friends_count:
          type: integer
        books_read:
          type: integer
        reviews_count:
          type: integer
        books_this_year:
          type: integer
        average_rating:
          type: number
          nullable: true
        is_ghost:
          type: boolean
        is_restricted:
          type: boolean
          description: "True if private profile and viewer has no access"

    UserSearchResult:
      type: object
      properties:
        user_id:
          type: string
          format: uuid
        username:
          type: string
        display_name:
          type: string
          nullable: true

    ShelfResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        slug:
          type: string
        exclusive_group:
          type: string
        collection_type:
          type: string
          enum: [shelf, tag]
        item_count:
          type: integer
        books:
          type: array
          items:
            $ref: '#/components/schemas/ShelfDetailBook'

    ShelfDetailBook:
      type: object
      properties:
        book_id:
          type: string
          format: uuid
        open_library_id:
          type: string
        title:
          type: string
        cover_url:
          type: string
          nullable: true
        added_at:
          type: string
          format: date-time
        rating:
          type: integer
          nullable: true
          minimum: 1
          maximum: 5

    ShelfDetailResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        slug:
          type: string
        exclusive_group:
          type: string
        collection_type:
          type: string
        books:
          type: array
          items:
            $ref: '#/components/schemas/ShelfDetailBook'
        computed:
          type: object
          nullable: true
          description: >
            Present when this shelf was created from a set operation.
            For continuous lists (is_continuous=true), books are re-computed
            dynamically from the source collections on each view.
          properties:
            operation:
              type: string
              enum: [union, intersection, difference]
            is_continuous:
              type: boolean
            last_computed_at:
              type: string
              format: date-time

    UserBookItem:
      type: object
      properties:
        book_id:
          type: string
          format: uuid
        open_library_id:
          type: string
        title:
          type: string
        cover_url:
          type: string
          nullable: true
        authors:
          type: string
          nullable: true
        rating:
          type: integer
          nullable: true
        added_at:
          type: string
          format: date-time
        progress_pages:
          type: integer
          nullable: true
        progress_percent:
          type: integer
          nullable: true
        page_count:
          type: integer
          nullable: true
        device_total_pages:
          type: integer
          nullable: true

    BookStatus:
      type: object
      properties:
        status_value_id:
          type: string
          nullable: true
        status_name:
          type: string
          nullable: true
        status_slug:
          type: string
          nullable: true
        rating:
          type: integer
          nullable: true
        review_text:
          type: string
          nullable: true
        spoiler:
          type: boolean
        date_read:
          type: string
          format: date-time
          nullable: true
        date_dnf:
          type: string
          format: date-time
          nullable: true
        progress_pages:
          type: integer
          nullable: true
        progress_percent:
          type: integer
          nullable: true
        device_total_pages:
          type: integer
          nullable: true

    TagKeyResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        slug:
          type: string
        mode:
          type: string
          enum: [select_one, select_multiple]
        values:
          type: array
          items:
            $ref: '#/components/schemas/TagValueResponse'

    TagValueResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        slug:
          type: string

    BookTagResponse:
      type: object
      properties:
        key_id:
          type: string
          format: uuid
        key_name:
          type: string
        key_slug:
          type: string
        value_id:
          type: string
          format: uuid
        value_name:
          type: string
        value_slug:
          type: string

    ThreadResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        book_id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        username:
          type: string
        display_name:
          type: string
          nullable: true
        avatar_url:
          type: string
          nullable: true
        title:
          type: string
        body:
          type: string
        spoiler:
          type: boolean
        created_at:
          type: string
          format: date-time
        comment_count:
          type: integer

    SimilarThreadResponse:
      allOf:
        - $ref: '#/components/schemas/ThreadResponse'
        - type: object
          properties:
            similarity:
              type: number
              format: float
              description: Trigram similarity score (0–1)

    CommentResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        thread_id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        username:
          type: string
        display_name:
          type: string
          nullable: true
        avatar_url:
          type: string
          nullable: true
        parent_id:
          type: string
          format: uuid
          nullable: true
        body:
          type: string
        created_at:
          type: string
          format: date-time

    ActivityItem:
      type: object
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum: [shelved, started_book, finished_book, rated, reviewed, created_thread, followed_user, followed_author, followed_book, created_link]
        created_at:
          type: string
          format: date-time
        user:
          type: object
          properties:
            user_id:
              type: string
            username:
              type: string
            display_name:
              type: string
              nullable: true
            avatar_url:
              type: string
              nullable: true
        book:
          type: object
          nullable: true
          properties:
            open_library_id:
              type: string
            title:
              type: string
            cover_url:
              type: string
              nullable: true
        target_user:
          type: object
          nullable: true
          properties:
            user_id:
              type: string
            username:
              type: string
            display_name:
              type: string
              nullable: true
            avatar_url:
              type: string
              nullable: true
        shelf_name:
          type: string
          nullable: true
        rating:
          type: integer
          nullable: true
        review_snippet:
          type: string
          nullable: true
        thread_title:
          type: string
          nullable: true
        link_type:
          type: string
          nullable: true
          description: Type of community link (sequel, prequel, companion, etc.)
        to_book_ol_id:
          type: string
          nullable: true
          description: Open Library ID of the target book for created_link activities
        to_book_title:
          type: string
          nullable: true
          description: Title of the target book for created_link activities
        author_key:
          type: string
          nullable: true
          description: Open Library author key for followed_author activities
        author_name:
          type: string
          nullable: true
          description: Author name for followed_author activities

    FeedResponse:
      type: object
      properties:
        activities:
          type: array
          items:
            $ref: '#/components/schemas/ActivityItem'
        next_cursor:
          type: string
          description: "RFC3339Nano cursor for next page"

    Review:
      type: object
      properties:
        username:
          type: string
        display_name:
          type: string
          nullable: true
        avatar_url:
          type: string
          nullable: true
        rating:
          type: integer
          nullable: true
        review_text:
          type: string
        spoiler:
          type: boolean
        date_read:
          type: string
          format: date-time
          nullable: true
        date_dnf:
          type: string
          format: date-time
          nullable: true
        date_added:
          type: string
          format: date-time
        is_followed:
          type: boolean

    UserReview:
      type: object
      properties:
        book_id:
          type: string
          format: uuid
        open_library_id:
          type: string
        title:
          type: string
        cover_url:
          type: string
          nullable: true
        authors:
          type: string
          nullable: true
        rating:
          type: integer
          nullable: true
        review_text:
          type: string
        spoiler:
          type: boolean
        date_read:
          type: string
          format: date-time
          nullable: true
        date_dnf:
          type: string
          format: date-time
          nullable: true
        date_added:
          type: string
          format: date-time

    FollowRequestUser:
      type: object
      properties:
        user_id:
          type: string
          format: uuid
        username:
          type: string
        display_name:
          type: string
          nullable: true
        avatar_url:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time

    PreviewRow:
      type: object
      properties:
        row_id:
          type: integer
        title:
          type: string
        author:
          type: string
        isbn13:
          type: string
        rating:
          type: integer
          nullable: true
        review_text:
          type: string
          nullable: true
        spoiler:
          type: boolean
        date_read:
          type: string
          nullable: true
        date_added:
          type: string
          nullable: true
        exclusive_shelf_slug:
          type: string
        custom_shelves:
          type: array
          items:
            type: string
        status:
          type: string
          enum: [matched, ambiguous, unmatched]
        match:
          $ref: '#/components/schemas/BookCandidate'
        candidates:
          type: array
          items:
            $ref: '#/components/schemas/BookCandidate'

    BookCandidate:
      type: object
      properties:
        ol_id:
          type: string
        title:
          type: string
        authors:
          type: array
          items:
            type: string
        cover_url:
          type: string
          nullable: true
        year:
          type: integer
          nullable: true

    AggregateGenreRating:
      type: object
      properties:
        genre:
          type: string
          example: "Science fiction"
        average:
          type: number
          format: float
          example: 7.3
        rater_count:
          type: integer
          example: 12

    GenreRating:
      type: object
      properties:
        genre:
          type: string
          example: "Science fiction"
        rating:
          type: integer
          minimum: 0
          maximum: 10
          example: 8
        updated_at:
          type: string
          format: date-time

    GenreRatingInput:
      type: object
      required: [genre]
      properties:
        genre:
          type: string
          example: "Science fiction"
        rating:
          type: integer
          minimum: 0
          maximum: 10
          nullable: true
          description: "0 or null to remove the rating"

paths:
  /health:
    get:
      summary: Health check
      tags: [Auth]
      responses:
        "200":
          description: Healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  db:
                    type: string

  /auth/register:
    post:
      summary: Register a new account
      description: |
        Creates a new user account and sends a verification email. The returned
        JWT has `email_verified: false` until the user clicks the verification link.
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [username, email, password]
              properties:
                username:
                  type: string
                  description: "Lowercase, alphanumeric + hyphens, 1-40 chars"
                email:
                  type: string
                  format: email
                password:
                  type: string
                  minLength: 8
      responses:
        "201":
          description: Account created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "409":
          description: Email or username already taken
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/login:
    post:
      summary: Log in to an existing account
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/google:
    post:
      summary: Sign in or register with Google OAuth
      description: |
        Accepts verified Google user info (google_id, email, name) from the webapp
        after it has exchanged an authorization code for tokens. Finds an existing
        user by google_id, links Google to an existing email-based account, or
        creates a new account. Returns a JWT token.
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [google_id, email]
              properties:
                google_id:
                  type: string
                  description: Google user ID
                email:
                  type: string
                  format: email
                name:
                  type: string
                  description: Display name from Google profile
      responses:
        "200":
          description: Existing user signed in
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        "201":
          description: New account created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        "409":
          description: Email already registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/forgot-password:
    post:
      summary: Request a password reset
      description: |
        Sends a password reset email to the given address if an account exists.
        Always returns 200 to avoid leaking whether an email is registered.
        The reset link expires after 1 hour.
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email]
              properties:
                email:
                  type: string
                  format: email
      responses:
        "200":
          description: Reset email sent (or silently ignored if email not found)
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  message:
                    type: string

  /auth/reset-password:
    post:
      summary: Reset password with token
      description: |
        Validates the reset token from the email link and sets a new password.
        The token is single-use and expires after 1 hour.
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [token, new_password]
              properties:
                token:
                  type: string
                  description: Reset token from the email link
                new_password:
                  type: string
                  minLength: 8
      responses:
        "200":
          description: Password reset successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ok'
        "400":
          description: Invalid or expired token, or password too short
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/verify-email:
    post:
      summary: Verify email address
      description: |
        Validates the verification token from the email link and marks the user's
        email as verified. Returns a fresh JWT with `email_verified: true`.
        The token is single-use and expires after 24 hours.
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [token]
              properties:
                token:
                  type: string
                  description: Verification token from the email link
      responses:
        "200":
          description: Email verified successfully, returns fresh JWT
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        "400":
          description: Invalid or expired verification token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/resend-verification:
    post:
      summary: Resend verification email
      description: |
        Generates a new verification token and sends a verification email.
        Requires authentication. Returns immediately; email is sent asynchronously.
        No-ops if email is already verified.
      tags: [Auth]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Verification email sent (or already verified)
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  message:
                    type: string

  /me/account:
    get:
      summary: Get account info
      description: Returns whether the current user has a password set, whether Google is linked, and whether email is verified.
      tags: [Auth]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Account info
          content:
            application/json:
              schema:
                type: object
                properties:
                  has_password:
                    type: boolean
                  has_google:
                    type: boolean
                  email_verified:
                    type: boolean

  /me/password:
    put:
      summary: Set or change password
      description: |
        Sets a new password for the current user. If the user already has a password,
        `current_password` is required. Google OAuth-only users can call this with
        just `new_password` to enable email+password sign-in.
      tags: [Auth]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [new_password]
              properties:
                current_password:
                  type: string
                  description: Required if the user already has a password
                new_password:
                  type: string
                  minLength: 8
      responses:
        "200":
          description: Password set/changed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ok'
        "400":
          description: Validation error (password too short, missing current password)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "401":
          description: Current password is incorrect
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /books/search:
    get:
      summary: Search for books
      description: |
        Searches both the local Meilisearch catalog and Open Library.
        Local matches appear first, followed by external results deduplicated by OL work ID.
      tags: [Books]
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
          description: Search query (book title)
        - name: sort
          in: query
          schema:
            type: string
            enum: [reads, rating]
          description: "Sort order. Default: relevance blended with popularity"
        - name: year_min
          in: query
          schema:
            type: integer
          description: Minimum first publish year
        - name: year_max
          in: query
          schema:
            type: integer
          description: Maximum first publish year
        - name: subject
          in: query
          schema:
            type: string
          description: "Filter by subject/genre (e.g. fiction, fantasy)"
        - name: language
          in: query
          schema:
            type: string
          description: "Filter by language code (e.g. eng, spa)"
      responses:
        "200":
          description: Search results
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                  results:
                    type: array
                    items:
                      $ref: '#/components/schemas/BookResult'

  /books/lookup:
    get:
      summary: Look up a book by ISBN
      description: Queries Open Library by ISBN, upserts into local catalog, and returns the result.
      tags: [Books]
      parameters:
        - name: isbn
          in: query
          required: true
          schema:
            type: string
          description: ISBN-10 or ISBN-13
      responses:
        "200":
          description: Book found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BookResult'
        "404":
          description: Book not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /books/{workId}:
    get:
      summary: Get book details
      tags: [Books]
      parameters:
        - name: workId
          in: path
          required: true
          schema:
            type: string
          description: "Bare Open Library work ID (e.g. OL82592W)"
      responses:
        "200":
          description: Book details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BookDetail'
        "404":
          description: Book not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /books/{workId}/editions:
    get:
      summary: List editions of a work
      description: Returns editions from Open Library with cover, format, publisher, page count, ISBN, and language.
      tags: [Books]
      parameters:
        - name: workId
          in: path
          required: true
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        "200":
          description: Paginated list of editions
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                  editions:
                    type: array
                    items:
                      $ref: '#/components/schemas/Edition'
        "404":
          description: Work not found

  /books/{workId}/reviews:
    get:
      summary: Get community reviews for a book
      description: Returns reviews from local DB. If authenticated, reviews from followed users appear first.
      tags: [Books]
      parameters:
        - name: workId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: List of reviews
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Review'

  /books/{workId}/threads:
    get:
      summary: List discussion threads for a book
      tags: [Threads]
      parameters:
        - name: workId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: List of threads
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ThreadResponse'
    post:
      summary: Create a discussion thread
      tags: [Threads]
      security:
        - BearerAuth: []
      parameters:
        - name: workId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [title, body]
              properties:
                title:
                  type: string
                body:
                  type: string
                spoiler:
                  type: boolean
                  default: false
      responses:
        "201":
          description: Thread created
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  created_at:
                    type: string
                    format: date-time

  /threads/{threadId}:
    get:
      summary: Get a thread with its comments
      tags: [Threads]
      parameters:
        - name: threadId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Thread and comments
          content:
            application/json:
              schema:
                type: object
                properties:
                  thread:
                    $ref: '#/components/schemas/ThreadResponse'
                  comments:
                    type: array
                    items:
                      $ref: '#/components/schemas/CommentResponse'
    delete:
      summary: Delete a thread (soft delete, author only)
      tags: [Threads]
      security:
        - BearerAuth: []
      parameters:
        - name: threadId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Thread deleted

  /threads/{threadId}/comments:
    post:
      summary: Add a comment to a thread
      description: Supports one level of nesting. Set parent_id to reply to a top-level comment.
      tags: [Threads]
      security:
        - BearerAuth: []
      parameters:
        - name: threadId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [body]
              properties:
                body:
                  type: string
                parent_id:
                  type: string
                  format: uuid
                  description: "Reply to this comment (one level deep only)"
      responses:
        "201":
          description: Comment created
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  created_at:
                    type: string
                    format: date-time

  /threads/{threadId}/comments/{commentId}:
    delete:
      summary: Delete a comment (soft delete, author only)
      tags: [Threads]
      security:
        - BearerAuth: []
      parameters:
        - name: threadId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: commentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Comment deleted

  /books/{workId}/similar-threads:
    get:
      summary: Find similar threads by title (pre-creation check)
      description: Returns existing threads on the same book whose titles are similar to the given title. Uses PostgreSQL pg_trgm trigram similarity with a threshold of 0.3.
      tags: [Threads]
      parameters:
        - name: workId
          in: path
          required: true
          schema:
            type: string
        - name: title
          in: query
          required: true
          schema:
            type: string
          description: Title to compare against existing threads
      responses:
        "200":
          description: Similar threads (up to 5, sorted by similarity descending)
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/SimilarThreadResponse'

  /threads/{threadId}/similar:
    get:
      summary: Get similar threads for an existing thread
      description: Returns other threads on the same book whose titles are similar to the given thread. Uses PostgreSQL pg_trgm trigram similarity with a threshold of 0.3.
      tags: [Threads]
      parameters:
        - name: threadId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Similar threads (up to 5, sorted by similarity descending)
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/SimilarThreadResponse'

  /authors/search:
    get:
      summary: Search for authors
      tags: [Authors]
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
          description: Author name query
      responses:
        "200":
          description: Search results
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                  results:
                    type: array
                    items:
                      $ref: '#/components/schemas/AuthorResult'

  /authors/{authorKey}:
    get:
      summary: Get author details
      tags: [Authors]
      parameters:
        - name: authorKey
          in: path
          required: true
          schema:
            type: string
          description: "Open Library author key (e.g. OL123A)"
      responses:
        "200":
          description: Author details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthorDetail'
        "404":
          description: Author not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /authors/{authorKey}/follow:
    get:
      summary: Check if you follow an author
      tags: [Authors]
      security:
        - BearerAuth: []
      parameters:
        - name: authorKey
          in: path
          required: true
          schema:
            type: string
          description: "Open Library author key (e.g. OL123A)"
      responses:
        "200":
          description: Follow status
          content:
            application/json:
              schema:
                type: object
                properties:
                  following:
                    type: boolean
    post:
      summary: Follow an author
      tags: [Authors]
      security:
        - BearerAuth: []
      parameters:
        - name: authorKey
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                author_name:
                  type: string
                  description: "Author display name (stored for feed display)"
      responses:
        "200":
          description: Followed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ok'
    delete:
      summary: Unfollow an author
      tags: [Authors]
      security:
        - BearerAuth: []
      parameters:
        - name: authorKey
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Unfollowed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ok'

  /me/followed-authors:
    get:
      summary: List authors you follow
      tags: [Authors]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Followed authors
          content:
            application/json:
              schema:
                type: object
                properties:
                  authors:
                    type: array
                    items:
                      type: object
                      properties:
                        author_key:
                          type: string
                        author_name:
                          type: string
                        created_at:
                          type: string
                          format: date-time

  /books/{workId}/follow:
    get:
      summary: Check if you follow a book
      tags: [Books]
      security:
        - BearerAuth: []
      parameters:
        - name: workId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Follow status
          content:
            application/json:
              schema:
                type: object
                properties:
                  following:
                    type: boolean
    post:
      summary: Follow a book
      description: Subscribe to notifications when new threads, links, or reviews are posted on this book.
      tags: [Books]
      security:
        - BearerAuth: []
      parameters:
        - name: workId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Followed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ok'
    delete:
      summary: Unfollow a book
      tags: [Books]
      security:
        - BearerAuth: []
      parameters:
        - name: workId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Unfollowed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ok'

  /me/followed-books:
    get:
      summary: List books you follow
      tags: [Books]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Followed books
          content:
            application/json:
              schema:
                type: object
                properties:
                  books:
                    type: array
                    items:
                      type: object
                      properties:
                        open_library_id:
                          type: string
                        title:
                          type: string
                        cover_url:
                          type: string
                          nullable: true
                        authors:
                          type: string
                          nullable: true
                        created_at:
                          type: string
                          format: date-time

  /genres:
    get:
      summary: List predefined genres with book counts
      tags: [Genres]
      responses:
        "200":
          description: Genre list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/GenreInfo'

  /genres/{slug}/books:
    get:
      summary: Browse books in a genre
      tags: [Genres]
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
          description: "Genre slug (e.g. science-fiction)"
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
      responses:
        "200":
          description: Genre books
          content:
            application/json:
              schema:
                type: object
                properties:
                  genre:
                    type: string
                  total:
                    type: integer
                  page:
                    type: integer
                  results:
                    type: array
                    items:
                      $ref: '#/components/schemas/BookResult'

  /users:
    get:
      summary: Search or browse users
      tags: [Users]
      parameters:
        - name: q
          in: query
          schema:
            type: string
          description: "Search query (matches username and display name). Omit for paginated browse."
        - name: page
          in: query
          schema:
            type: integer
            default: 1
      responses:
        "200":
          description: User list
          content:
            application/json:
              schema:
                oneOf:
                  - description: "When q is empty: paginated list"
                    type: object
                    properties:
                      users:
                        type: array
                        items:
                          $ref: '#/components/schemas/UserSearchResult'
                      page:
                        type: integer
                      has_next:
                        type: boolean
                  - description: "When q is provided: flat array"
                    type: array
                    items:
                      $ref: '#/components/schemas/UserSearchResult'

  /users/{username}:
    get:
      summary: Get user profile
      description: Public, but private profiles restrict stats unless viewer is owner or active follower.
      tags: [Users]
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Profile data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileResponse'
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /users/{username}/reviews:
    get:
      summary: Get a user's reviews
      description: Gated for private profiles.
      tags: [Users]
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
      responses:
        "200":
          description: Reviews
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UserReview'

  /users/{username}/shelves:
    get:
      summary: Get a user's shelves
      description: "Gated for private profiles. Use include_books=N to include preview books per shelf."
      tags: [Collections]
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
        - name: include_books
          in: query
          schema:
            type: integer
          description: "Number of preview books to include per shelf"
      responses:
        "200":
          description: Shelves
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ShelfResponse'

  /users/{username}/shelves/{slug}:
    get:
      summary: Get a specific shelf with books
      tags: [Collections]
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
        - name: slug
          in: path
          required: true
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 200
      responses:
        "200":
          description: Shelf detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShelfDetailResponse'

  /users/{username}/books:
    get:
      summary: Get a user's books grouped by status
      description: |
        Without status filter, returns books grouped by status label with counts.
        With `?status=<slug>`, returns a flat list of books in that status.
      tags: [User Books]
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
        - name: status
          in: query
          schema:
            type: string
          description: "Filter by status slug (e.g. finished, currently-reading)"
        - name: limit
          in: query
          schema:
            type: integer
            default: 8
      responses:
        "200":
          description: User books
          content:
            application/json:
              schema:
                type: object
                properties:
                  statuses:
                    type: array
                    items:
                      type: object
                      properties:
                        name:
                          type: string
                        slug:
                          type: string
                        count:
                          type: integer
                        books:
                          type: array
                          items:
                            $ref: '#/components/schemas/UserBookItem'
                  unstatused_count:
                    type: integer

  /users/{username}/tags/{path}:
    get:
      summary: Get books tagged with a path
      description: "Returns books matching the tag path or any sub-tag. E.g. /users/alice/tags/sci-fi includes books tagged sci-fi/moon."
      tags: [Collections]
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
        - name: path
          in: path
          required: true
          schema:
            type: string
          description: Tag path (e.g. sci-fi or sci-fi/moon)
      responses:
        "200":
          description: Tagged books
          content:
            application/json:
              schema:
                type: object
                properties:
                  path:
                    type: string
                  sub_tags:
                    type: array
                    items:
                      type: string
                  books:
                    type: array
                    items:
                      $ref: '#/components/schemas/ShelfDetailBook'

  /users/{username}/tag-keys:
    get:
      summary: Get a user's tag keys (excludes Status)
      tags: [Tags]
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Tag keys
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TagKeyResponse'

  /users/{username}/labels/{keySlug}/{valuePath}:
    get:
      summary: Get books with a specific label value
      description: "Hierarchical label browsing. E.g. /users/alice/labels/genre/sci-fi"
      tags: [Tags]
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
        - name: keySlug
          in: path
          required: true
          schema:
            type: string
        - name: valuePath
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Label books
          content:
            application/json:
              schema:
                type: object
                properties:
                  key_slug:
                    type: string
                  key_name:
                    type: string
                  value_slug:
                    type: string
                  value_name:
                    type: string
                  sub_labels:
                    type: array
                    items:
                      type: string
                  books:
                    type: array
                    items:
                      $ref: '#/components/schemas/ShelfDetailBook'

  /users/{username}/activity:
    get:
      summary: Get a user's activity feed
      tags: [Activity]
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
        - name: cursor
          in: query
          schema:
            type: string
          description: "RFC3339Nano cursor for pagination"
        - name: limit
          in: query
          schema:
            type: integer
            default: 30
            maximum: 30
      responses:
        "200":
          description: Activity feed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeedResponse'

  /users/me:
    patch:
      summary: Update your profile
      tags: [Users]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                display_name:
                  type: string
                bio:
                  type: string
                is_private:
                  type: boolean
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ok'

  /me/avatar:
    post:
      summary: Upload avatar image
      tags: [Users]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                avatar:
                  type: string
                  format: binary
                  description: "Image file, max 5 MB"
      responses:
        "200":
          description: Avatar uploaded
          content:
            application/json:
              schema:
                type: object
                properties:
                  avatar_url:
                    type: string

  /users/{username}/follow:
    post:
      summary: Follow a user
      description: "Private accounts create a pending follow request."
      tags: [Users]
      security:
        - BearerAuth: []
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Followed
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  status:
                    type: string
                    enum: [active, pending]
    delete:
      summary: Unfollow a user
      tags: [Users]
      security:
        - BearerAuth: []
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Unfollowed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ok'

  /me/follow-requests:
    get:
      summary: List pending follow requests
      tags: [Users]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Follow requests
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/FollowRequestUser'

  /me/follow-requests/{userId}/accept:
    post:
      summary: Accept a follow request
      tags: [Users]
      security:
        - BearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ok'

  /me/follow-requests/{userId}/reject:
    delete:
      summary: Reject a follow request
      tags: [Users]
      security:
        - BearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Rejected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ok'

  /me/feed:
    get:
      summary: Get your personalized feed
      description: "Chronological feed of activity from users you follow. Cursor-based pagination."
      tags: [Activity]
      security:
        - BearerAuth: []
      parameters:
        - name: cursor
          in: query
          schema:
            type: string
          description: "RFC3339Nano cursor for pagination"
      responses:
        "200":
          description: Feed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeedResponse'

  /me/shelves:
    get:
      summary: List your shelves with books
      tags: [Collections]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Your shelves
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                      format: uuid
                    name:
                      type: string
                    slug:
                      type: string
                    exclusive_group:
                      type: string
                    collection_type:
                      type: string
                    books:
                      type: array
                      items:
                        type: object
                        properties:
                          book_id:
                            type: string
                          open_library_id:
                            type: string
                          title:
                            type: string
                          cover_url:
                            type: string
                            nullable: true
    post:
      summary: Create a custom shelf or tag
      tags: [Collections]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                  maxLength: 255
                is_exclusive:
                  type: boolean
                  default: false
                exclusive_group:
                  type: string
                  maxLength: 100
                is_public:
                  type: boolean
                  default: true
                type:
                  type: string
                  enum: [shelf, tag]
                  default: shelf
      responses:
        "201":
          description: Shelf created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShelfResponse'
        "409":
          description: Duplicate slug
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /me/shelves/{id}:
    patch:
      summary: Update a shelf (rename or toggle visibility)
      tags: [Collections]
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                is_public:
                  type: boolean
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShelfResponse'
    delete:
      summary: Delete a custom shelf
      description: "Default read-status shelves cannot be deleted."
      tags: [Collections]
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ok'

  /me/shelves/set-operation:
    post:
      summary: Compute set operation between two collections
      description: >
        Returns the union, intersection, or difference of two collections belonging to the authenticated user.
        Union: books in either collection.
        Intersection: books in both collections.
        Difference: books in collection_a but not in collection_b.
      tags: [Collections]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [collection_a, collection_b, operation]
              properties:
                collection_a:
                  type: string
                  format: uuid
                  description: ID of the first collection
                collection_b:
                  type: string
                  format: uuid
                  description: ID of the second collection
                operation:
                  type: string
                  enum: [union, intersection, difference]
      responses:
        "200":
          description: Set operation result
          content:
            application/json:
              schema:
                type: object
                properties:
                  operation:
                    type: string
                  collection_a:
                    type: string
                  collection_b:
                    type: string
                  result_count:
                    type: integer
                  books:
                    type: array
                    items:
                      $ref: '#/components/schemas/ShelfDetailBook'
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "404":
          description: One or both collections not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /me/shelves/set-operation/save:
    post:
      summary: Compute set operation and save result as a new collection
      description: >
        Computes the set operation and creates a new shelf containing the resulting books.
        If is_continuous is true, the list auto-refreshes when viewed — the operation is
        re-executed against the current source collections each time the shelf is fetched.
      tags: [Collections]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [collection_a, collection_b, operation, name]
              properties:
                collection_a:
                  type: string
                  format: uuid
                collection_b:
                  type: string
                  format: uuid
                operation:
                  type: string
                  enum: [union, intersection, difference]
                name:
                  type: string
                  maxLength: 255
                  description: Name for the new collection
                is_continuous:
                  type: boolean
                  default: false
                  description: >
                    If true, creates a live list that re-executes the operation on each view.
                    If false (default), creates a static snapshot.
      responses:
        "201":
          description: Collection created
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  name:
                    type: string
                  slug:
                    type: string
                  book_count:
                    type: integer
                  is_continuous:
                    type: boolean
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "404":
          description: One or both collections not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "409":
          description: Duplicate slug
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /me/shelves/cross-user-compare:
    post:
      summary: Compare your collection with another user's collection
      description: >
        Computes the union, intersection, or difference between one of your collections
        and another user's public collection (identified by username and shelf slug).
        Respects profile privacy — returns 403 for private profiles you don't follow.
      tags: [Collections]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [my_collection, their_username, their_slug, operation]
              properties:
                my_collection:
                  type: string
                  format: uuid
                  description: ID of your collection
                their_username:
                  type: string
                  description: The other user's username
                their_slug:
                  type: string
                  description: Slug of the other user's collection
                operation:
                  type: string
                  enum: [union, intersection, difference]
      responses:
        "200":
          description: Cross-user set operation result
          content:
            application/json:
              schema:
                type: object
                properties:
                  operation:
                    type: string
                  my_collection:
                    type: string
                  their_username:
                    type: string
                  their_slug:
                    type: string
                  result_count:
                    type: integer
                  books:
                    type: array
                    items:
                      $ref: '#/components/schemas/ShelfDetailBook'
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "403":
          description: User's profile is private
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "404":
          description: User or collection not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /me/shelves/cross-user-compare/save:
    post:
      summary: Compare with another user's collection and save the result
      description: >
        Computes the cross-user set operation and creates a new shelf containing the resulting books.
        If is_continuous is true, the list auto-refreshes when viewed — the operation is
        re-executed against the current source collections each time the shelf is fetched.
      tags: [Collections]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [my_collection, their_username, their_slug, operation, name]
              properties:
                my_collection:
                  type: string
                  format: uuid
                their_username:
                  type: string
                their_slug:
                  type: string
                operation:
                  type: string
                  enum: [union, intersection, difference]
                name:
                  type: string
                  maxLength: 255
                  description: Name for the new collection
                is_continuous:
                  type: boolean
                  default: false
                  description: >
                    If true, creates a live list that re-executes the operation on each view.
                    If false (default), creates a static snapshot.
      responses:
        "201":
          description: Collection created
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  name:
                    type: string
                  slug:
                    type: string
                  book_count:
                    type: integer
                  is_continuous:
                    type: boolean
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "403":
          description: User's profile is private
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "404":
          description: User or collection not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "409":
          description: Duplicate slug
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /shelves/{shelfId}/books:
    post:
      summary: Add a book to a shelf
      description: "Upserts the book, enforces mutual exclusivity within exclusive groups."
      tags: [Collections]
      security:
        - BearerAuth: []
      parameters:
        - name: shelfId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [open_library_id, title]
              properties:
                open_library_id:
                  type: string
                title:
                  type: string
                cover_url:
                  type: string
      responses:
        "200":
          description: Book added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ok'

  /shelves/{shelfId}/books/{olId}:
    patch:
      summary: Update book metadata in a shelf (rating, review, dates)
      tags: [Collections]
      security:
        - BearerAuth: []
      parameters:
        - name: shelfId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: olId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                rating:
                  type: integer
                  minimum: 1
                  maximum: 5
                  nullable: true
                review_text:
                  type: string
                  nullable: true
                spoiler:
                  type: boolean
                date_read:
                  type: string
                  nullable: true
                  description: "RFC3339 or YYYY-MM-DD"
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ok'
    delete:
      summary: Remove a book from a shelf
      tags: [Collections]
      security:
        - BearerAuth: []
      parameters:
        - name: shelfId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: olId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Removed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ok'

  /me/books:
    post:
      summary: Add a book to your library
      tags: [User Books]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [open_library_id, title]
              properties:
                open_library_id:
                  type: string
                title:
                  type: string
                cover_url:
                  type: string
                status_value_id:
                  type: string
                  format: uuid
                  description: "Optional status label value to set"
      responses:
        "200":
          description: Book added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ok'

  /me/books/status-map:
    get:
      summary: Get status map for all your books
      description: "Returns a map of Open Library ID to status value ID for every book in your library."
      tags: [User Books]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Status map
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  type: string
                description: "Map of OL ID to status value UUID"

  /me/books/{olId}/status:
    get:
      summary: Get your status for a specific book
      tags: [User Books]
      security:
        - BearerAuth: []
      parameters:
        - name: olId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Book status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BookStatus'
        "404":
          description: Book not in library

  /me/books/{olId}:
    patch:
      summary: Update book metadata (rating, review, progress, dates)
      description: "Only fields present in the request body are updated. Send null to clear a field."
      tags: [User Books]
      security:
        - BearerAuth: []
      parameters:
        - name: olId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                rating:
                  type: integer
                  minimum: 1
                  maximum: 5
                  nullable: true
                review_text:
                  type: string
                  nullable: true
                spoiler:
                  type: boolean
                date_read:
                  type: string
                  nullable: true
                  description: "RFC3339 or YYYY-MM-DD"
                date_dnf:
                  type: string
                  nullable: true
                  description: "RFC3339 or YYYY-MM-DD"
                progress_pages:
                  type: integer
                  nullable: true
                progress_percent:
                  type: integer
                  minimum: 0
                  maximum: 100
                  nullable: true
                device_total_pages:
                  type: integer
                  minimum: 1
                  nullable: true
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ok'
    delete:
      summary: Remove a book from your library
      tags: [User Books]
      security:
        - BearerAuth: []
      parameters:
        - name: olId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Removed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ok'

  /me/books/{olId}/tags:
    get:
      summary: Get all label assignments for a book
      tags: [Tags]
      security:
        - BearerAuth: []
      parameters:
        - name: olId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Book tags
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/BookTagResponse'

  /me/books/{olId}/tags/{keyId}:
    put:
      summary: Set a label on a book
      description: |
        For select_one keys, replaces any existing value.
        For select_multiple keys, adds the value (idempotent).
        Use value_id for existing values or value_name to find-or-create.
      tags: [Tags]
      security:
        - BearerAuth: []
      parameters:
        - name: olId
          in: path
          required: true
          schema:
            type: string
        - name: keyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                value_id:
                  type: string
                  format: uuid
                value_name:
                  type: string
                  description: "Find-or-create a value by name"
      responses:
        "200":
          description: Tag set
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ok'
    delete:
      summary: Remove all label assignments for a key from a book
      tags: [Tags]
      security:
        - BearerAuth: []
      parameters:
        - name: olId
          in: path
          required: true
          schema:
            type: string
        - name: keyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Tag unset
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ok'

  /me/books/{olId}/tags/{keyId}/values/{valueId}:
    delete:
      summary: Remove a specific label value from a book
      description: "For select_multiple keys, removes one value without affecting others."
      tags: [Tags]
      security:
        - BearerAuth: []
      parameters:
        - name: olId
          in: path
          required: true
          schema:
            type: string
        - name: keyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: valueId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Value removed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ok'

  /me/tag-keys:
    get:
      summary: List your tag keys (including Status)
      tags: [Tags]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Tag keys
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TagKeyResponse'
    post:
      summary: Create a custom tag key
      tags: [Tags]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                  maxLength: 100
                mode:
                  type: string
                  enum: [select_one, select_multiple]
                  default: select_one
      responses:
        "201":
          description: Tag key created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TagKeyResponse'

  /me/tag-keys/{keyId}:
    delete:
      summary: Delete a tag key and all its values
      tags: [Tags]
      security:
        - BearerAuth: []
      parameters:
        - name: keyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ok'

  /me/tag-keys/{keyId}/values:
    post:
      summary: Create a value for a tag key
      tags: [Tags]
      security:
        - BearerAuth: []
      parameters:
        - name: keyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                  maxLength: 100
      responses:
        "201":
          description: Tag value created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TagValueResponse'

  /me/tag-keys/{keyId}/values/{valueId}:
    delete:
      summary: Delete a tag value
      tags: [Tags]
      security:
        - BearerAuth: []
      parameters:
        - name: keyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: valueId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ok'

  /me/import/goodreads/preview:
    post:
      summary: Preview a Goodreads CSV import
      description: |
        Upload a Goodreads CSV export file. Returns a categorized preview of matched,
        ambiguous, and unmatched books. No database writes are performed.
      tags: [Import/Export]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: Goodreads CSV export file
      responses:
        "200":
          description: Import preview
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                  matched:
                    type: integer
                  ambiguous:
                    type: integer
                  unmatched:
                    type: integer
                  rows:
                    type: array
                    items:
                      $ref: '#/components/schemas/PreviewRow'

  /me/import/goodreads/commit:
    post:
      summary: Commit a Goodreads import
      description: "Accepts confirmed rows from the preview and writes them to the database."
      tags: [Import/Export]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [rows]
              properties:
                rows:
                  type: array
                  items:
                    type: object
                    required: [ol_id, title, exclusive_shelf_slug]
                    properties:
                      row_id:
                        type: integer
                      ol_id:
                        type: string
                      title:
                        type: string
                      cover_url:
                        type: string
                      authors:
                        type: string
                      publication_year:
                        type: integer
                      isbn13:
                        type: string
                      rating:
                        type: integer
                      review_text:
                        type: string
                      spoiler:
                        type: boolean
                      date_read:
                        type: string
                      date_added:
                        type: string
                      exclusive_shelf_slug:
                        type: string
                      custom_shelves:
                        type: array
                        items:
                          type: string
      responses:
        "200":
          description: Import result
          content:
            application/json:
              schema:
                type: object
                properties:
                  imported:
                    type: integer
                  failed:
                    type: integer
                  errors:
                    type: array
                    items:
                      type: string

  /me/export/csv:
    get:
      summary: Export your library as CSV
      description: "Downloads a CSV file. Optionally filter by status slug."
      tags: [Import/Export]
      security:
        - BearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
          description: "Filter by status slug (e.g. finished)"
      responses:
        "200":
          description: CSV download
          content:
            text/csv:
              schema:
                type: string
                format: binary

  # ── Notifications ────────────────────────────────────────────────────────────

  /me/notifications:
    get:
      tags: [Notifications]
      summary: List notifications
      description: Returns paginated notifications for the current user, newest first.
      security:
        - BearerAuth: []
      parameters:
        - name: cursor
          in: query
          schema:
            type: string
          description: "RFC 3339 Nano timestamp for cursor-based pagination"
      responses:
        "200":
          description: Notification list
          content:
            application/json:
              schema:
                type: object
                properties:
                  notifications:
                    type: array
                    items:
                      $ref: "#/components/schemas/Notification"
                  next_cursor:
                    type: string

  /me/notifications/unread-count:
    get:
      tags: [Notifications]
      summary: Get unread notification count
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Unread count
          content:
            application/json:
              schema:
                type: object
                properties:
                  count:
                    type: integer

  /me/notifications/{notifId}/read:
    post:
      tags: [Notifications]
      summary: Mark a notification as read
      security:
        - BearerAuth: []
      parameters:
        - name: notifId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Ok"
        "404":
          description: Notification not found

  /me/notifications/read-all:
    post:
      tags: [Notifications]
      summary: Mark all notifications as read
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Ok"

  /books/{workId}/stats:
    get:
      tags: [Books]
      summary: Get precomputed aggregate stats for a book
      description: |
        Returns cached aggregate stats from the book_stats table. Stats are
        updated asynchronously when users change statuses, ratings, or reviews.
      parameters:
        - name: workId
          in: path
          required: true
          schema:
            type: string
          example: OL82592W
      responses:
        "200":
          description: Aggregate book stats
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BookStats"
        "404":
          description: Book not found in local catalog

  /books/{workId}/genre-ratings:
    get:
      tags: [Genre Ratings]
      summary: Get aggregate genre ratings for a book
      parameters:
        - name: workId
          in: path
          required: true
          schema:
            type: string
          example: OL82592W
      responses:
        "200":
          description: Aggregate genre ratings sorted by rater count
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/AggregateGenreRating"

  /me/books/{olId}/genre-ratings:
    get:
      tags: [Genre Ratings]
      summary: Get your genre ratings for a book
      security:
        - BearerAuth: []
      parameters:
        - name: olId
          in: path
          required: true
          schema:
            type: string
          example: OL82592W
      responses:
        "200":
          description: Your genre ratings for this book
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/GenreRating"
    put:
      tags: [Genre Ratings]
      summary: Set your genre ratings for a book
      description: |
        Accepts an array of genre/rating pairs. Ratings of 0 or null remove the genre rating.
        Valid genres: Fiction, Non-fiction, Fantasy, Science fiction, Mystery, Romance, Horror,
        Thriller, Biography, History, Poetry, Children.
      security:
        - BearerAuth: []
      parameters:
        - name: olId
          in: path
          required: true
          schema:
            type: string
          example: OL82592W
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: "#/components/schemas/GenreRatingInput"
      responses:
        "200":
          description: Ratings saved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Ok"
        "400":
          description: Invalid genre or rating
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Book not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
